# 网络层

# 第四章 网络层

主要任务是**实现网络互联**，进而**实现数据包在各网络之间的传输**

## 4.1 网络层提供的两种服务

> 网络层向上只提供简单灵活的，无连接的，尽最大努力交付的数据报服务
>
> 网络层不提供服务质量的承诺

![](https://noclose-image.oss-cn-hangzhou.aliyuncs.com/img/%E7%BD%91%E7%BB%9C%E5%B1%82%E6%8F%90%E4%BE%9B%E7%9A%84%E4%B8%A4%E7%A7%8D%E6%9C%8D%E5%8A%A1.png)

> 虚电路表示这只是一条逻辑上的连接，分组都沿着这条逻辑连接按照存储转发方式传送，而不是真正建立了一条物理连接

虚电路服务与数据报服务的主要区别

![](https://noclose-image.oss-cn-hangzhou.aliyuncs.com/img/%E8%99%9A%E7%94%B5%E8%B7%AF%E6%9C%8D%E5%8A%A1%E4%B8%8E%E6%95%B0%E6%8D%AE%E6%8A%A5%E6%9C%8D%E5%8A%A1%E7%9A%84%E5%AF%B9%E6%AF%94.png)

- 面向连接的虚电路服务
  - **可靠通信由网络来保证**
  - 必须建立**网络层的连接——虚电路VC(Virtual Circuit)**
  - 通信双方**沿着已建立的虚电路发生分组**
  - 目的主机的地址仅在连接建立阶段使用，之后每个**分组的首部只需携带一条虚电路的编号**(构成虚电路的每一段链路都有一个虚电路编号）。
  - **通信结束后，需要释放之前所建立的虚电路**
- 无连接的数据报服务
  - **可靠通信应当由用户主机来保证**
  - **不需要建立网络层连接**
  - **每个分组可走不同的路径**
  - 每个分组的**首部必须携带目的主机的完整地址**
  - 这种通信方式所传送的**分组可能误码，丢失，重复**和**失序**
  - 由于**网络本身不提供端到端的可靠传输服务**，这就使网络中的路由器可以做得比较简单，而且价格低廉（与电信网的交换机相比较）
  - 因特网采用了这种设计思想，也就是**将复杂的网络处理功能置于因特网的边缘（用户主机和其内部的运输层)** ，而将相对简单的尽最大努力的分组交付功能置于因特网核心。

## 4.2 网际协议IP

与IP协议配套使用的三个协议：

- 地址解析协议ARP(Address Resolution Protocol)
- 网际控制协议ICMP(Internet Control Message Protocol)
- 网际组管理协议IGMP(Internet Group Management Protocol)

![](https://noclose-image.oss-cn-hangzhou.aliyuncs.com/img/%E7%BD%91%E9%99%85%E5%8D%8F%E8%AE%AEIP%E5%8F%8A%E5%85%B6%E9%85%8D%E5%A5%97%E5%8D%8F%E8%AE%AE.png)

### 4.2.1 虚拟互联网络

将网络互相连接起来要是用一些中间设备

中间设备

1. 物理层使用的中间设备叫做**转发器**
2. 数据链路层使用的中间设备叫做**网桥**或**桥接器**
3. 网络层使用的中间设备叫做**路由器**
4. 在网络层以上使用的中间设备叫做**网关**

### 4.2.2 分类的IP地址

IP地址的编址方法经过的三个阶段

1. **分类的IP地址**
2. **子网的划分**
3. **构成超网**

![](https://noclose-image.oss-cn-hangzhou.aliyuncs.com/img/IP%E5%9C%B0%E5%9D%80%E4%B8%AD%E7%9A%84%E7%BD%91%E7%BB%9C%E5%8F%B7%E5%AD%97%E6%AE%B5%E5%92%8C%E4%B8%BB%E6%9C%BA%E5%8F%B7%E5%AD%97%E6%AE%B5.png)

> 网络号：标志主机（或路由器）所连接到的网络，在互联网中是唯一的
>
> 主机号：标志该主机（或路由器），一台主机号在它前面的网络号所指明的网络范围内是唯一的

注意事项

> 只有A类、B类和C类地址可分配给网络中的主机或路由器的各接口
>
> 主机号为“全0”的地址是网络地址，不能分配给主机或路由器的各接口
>
> 主机号为“全1”的地址是广播地址，不能分配给主机或路由器的各接口

### 4.2.3 IP地址与硬件地址

- **IPv4地址**就是给因特网上的**每一台主机（或路由器）的每一个接口**分配一个在全世界范围内是**唯一的32比特的标识符**

#### MAC地址

MAC地址是以太网的MAC子层所使用的地址

![](https://noclose-image.oss-cn-hangzhou.aliyuncs.com/img/%E4%BD%BF%E7%94%A8%E5%B9%BF%E6%92%AD%E4%BF%A1%E9%81%93%E7%9A%84%E6%95%B0%E6%8D%AE%E9%93%BE%E8%B7%AF%E5%B1%82%E5%BF%85%E9%A1%BB%E4%BD%BF%E7%94%A8%E5%9C%B0%E5%9D%80%E6%9D%A5%E5%8C%BA%E5%88%86%E5%90%84%E4%B8%BB%E6%9C%BA.png)

- 当多个主机连接在同一个广播信道上，要想实现两个主机之间的通信，则每个主机都必须有一个唯一的标识，即一个数据链路层地址
- 在每个主机发送的**帧中必须携带标识发送主机和接收主机的地址**。由于这类地址是用于媒体接入控制MAC(Media Access Control),因此这类地址被称为**MAC地址**;
  - MAC地址一般被固化在网卡（网络适配器）的电可擦可编程只读存储器EEPROM中，因此MAC地址也被称为**硬件地址**
  - MAC地址有时也被称为**物理地址**。这并不意味着MAC地址属于网络体系结构中的物理层！
- 一般情况下，用户主机会包含两个网络适配器：有线局域网适配器（有线网卡）和无线局域网适配器（无线网卡）。每个网络适配器都有一个全球唯一的MAC地址。而交换机和路由器往往拥有更多的网络接口，所以会拥有更多的MAC地址。综上所述，**严格来说，MAC地址是对网络上各接口的唯一标识，而不是对网络上各设备的唯一标识。**

![](https://noclose-image.oss-cn-hangzhou.aliyuncs.com/img/IEEE%20802%E5%B1%80%E5%9F%9F%E7%BD%91%E7%9A%84MAC%E5%9C%B0%E5%9D%80%E6%A0%BC%E5%BC%8F.png)

![](https://noclose-image.oss-cn-hangzhou.aliyuncs.com/img/MAC%E5%9C%B0%E5%9D%80%E7%9A%84%E7%B1%BB%E5%9E%8B.png)

![](https://noclose-image.oss-cn-hangzhou.aliyuncs.com/img/MAC%E5%9C%B0%E5%9D%80%E7%9A%84%E5%8F%91%E9%80%81%E9%A1%BA%E5%BA%8F.png)

![](https://noclose-image.oss-cn-hangzhou.aliyuncs.com/img/%E5%8D%95%E6%92%ADMAC%E5%9C%B0%E5%9D%80%E4%BE%8B%E5%AD%90.png)

![](https://noclose-image.oss-cn-hangzhou.aliyuncs.com/img/%E5%B9%BF%E6%92%ADMAC%E5%9C%B0%E5%9D%80%E4%BE%8B%E5%AD%90.png)

![](https://noclose-image.oss-cn-hangzhou.aliyuncs.com/img/%E5%A4%9A%E6%92%ADMAC%E5%9C%B0%E5%9D%80%E4%BE%8B%E5%AD%90.png)

![](https://noclose-image.oss-cn-hangzhou.aliyuncs.com/img/%E4%BB%A5%E5%A4%AA%E7%BD%91V2%E7%9A%84MAC%E5%B8%A7%E6%A0%BC%E5%BC%8F.png)

#### IP地址

IP地址是TCP/IP体系结构网际层所使用的地址

- IP地址是因特网（Internet)上的主机和路由器所使用的地址，用于标识两部分信息：
  - **网络编号**：标识因特网上数以百万计的网络
  - **主机编号**：标识同一网络上不同主机（或路由器各接口）
- 在数据包的转发过程中，**源IP地址和目的IP地址始终保持不变**；而**源MAC地址和目的MAC地址逐段链路（或逐个网络）改变**。
  - ![](https://noclose-image.oss-cn-hangzhou.aliyuncs.com/img/%E6%95%B0%E6%8D%AE%E5%8C%85%E8%BD%AC%E5%8F%91%E8%BF%87%E7%A8%8B%E4%B8%ADIP%E5%9C%B0%E5%9D%80%E4%B8%8EMAC%E5%9C%B0%E5%9D%80%E7%9A%84%E5%8F%98%E5%8C%96%E6%83%85%E5%86%B5.png)

### 4.2.4 地址解析协议ARP

ARP协议属于TCP/IP体系结构的网际层，其作用是已知设备所分配到的IP地址，使用ARP协议可以通过该IP地址获取到设备的MAC地址；

![](https://noclose-image.oss-cn-hangzhou.aliyuncs.com/img/ARP1.png)

![](https://noclose-image.oss-cn-hangzhou.aliyuncs.com/img/ARP.gif)

### 4.2.5 IP数据报的格式

![](https://noclose-image.oss-cn-hangzhou.aliyuncs.com/img/IP%E6%95%B0%E6%8D%AE%E6%8A%A5%E7%9A%84%E6%A0%BC%E5%BC%8F.png)

**IP数据报首部的固定部分中的各字段**

- 版本
  - 占4 位，指IP 协议的版本。通信双方使用的IP 协议的版本必须一致。目前广泛使用的IP 协议版本号为4 （即1Pv4) 。关千以后要使用的1Pv6 （即版本6 的IP 协议），我们将在后面的4.6 节讨论。
- 首部长度
  - 占4 位，可表示的最大十进制数值是15 。请注意，首部长度字段所表示数的单位是32 位字(1 个32 位字长是4 字节）。因为IP 首部的固定长度是20 字节，因此首部长度字段的最小值是5 （即二进制表示的首部长度是0101) 。而当首部长度为最大值1111 时（即十进制数的15) ，就表明首部长度达到最大值15 个32 位字长，即60 字节。当IP 分组的首部长度不是4 字节的整数倍时，必须利用最后的填充字段加以填充。因此IP 数据报的数据部分永远在4 字节的整数倍时开始，这样在实现1P 协议时较为方便。首部长度限制为60 字节的缺点是有时可能不够用。但这样做是希望用户尽量减少开销。最常用的首部长度是20 字节（即首部长度为0101) ，这时不使用任何选项。
- 区分服务
  - 占8 位，用来获得更好的服务。这个字段在旧标准中叫做服务类型，但实际上一直没有被使用过。1998 年IETF 把这个字段改名为区分服务DS (DifferentiatedServices) 。只有在使用区分服务时，这个字段才起作用（见8.4.4 节）。在一般的情况下都不使用这个字段[RFC 2474, 3168, 3260] 。
- 总长度
  - 总长度指首部和数据之和的长度，单位为字节。总长度字段为16 位，因此数据报的最大长度为216 - 1 = 65535 字节。然而实际上传送这样长的数据报在现实中是极少遇到的。
- 标识(identification)
  - 占16 位。IP 软件在存储器中维持一个计数器，每产生一个数据报，计数器就加l ，并将此值赋给标识字段。但这个“标识”并不是序号，因为IP 是无连接服务，数据报不存在按序接收的问题。当数据报由于长度超过网络的MTU 而必须分片时，这个标识字段的值就被复制到所有的数据报片的标识字段中。相同的标识字段的值使分片后的各数据报片最后能正确地重装成为原来的数据报。
- 标志(flag)
  - 占3 位，但目前只有两位有意义。
  - 标志字段中的最低位记为MF (More Fragment) 。MF= 1 即表示后面”还有分片”的数据报。MF=O 表示这已是若干数据报片中的最后一个。
  - 标志字段中间的一位记为DF (Don't Fragment) ，意思是“不能分片”。只有当DF = 0 时才允许分片。
- 片偏移
  - 占13 位。片偏移指出：较长的分组在分片后，某片在原分组中的相对位置。也就是说，相对千用户数据字段的起点，该片从何处开始。片偏移以8 个字节为偏移单位。这就是说，每个分片的长度一定是8 字节(64 位）的整数倍。

### 4.2.6 IP层转发分组的流程

## 4.3 划分子网和构造超网

#### 划分子网

划分子网的IPv4地址

- **32比特的子网掩码可以表明分类IP地址的主机号部分被借用了几个比特作为子网号**
  - 子网掩码使用**连续的比特1来对应网络号和子网号**
  - 子网掩码使用**连续的比特0来对应主机号**
  - 将划分子网的**IPv4地址**与其相应的**子网掩码**进行**逻辑与运算**就可得到IPv4地址**所在子网的网络地址**
  - **默认的子网掩码是指在未划分子网的情况下使用的子网掩码**

![](https://noclose-image.oss-cn-hangzhou.aliyuncs.com/img/%E5%AD%90%E7%BD%91%E6%8E%A9%E7%A0%81%E9%80%BB%E8%BE%91%E4%B8%8E%E8%BF%90%E7%AE%97.png)

![](https://noclose-image.oss-cn-hangzhou.aliyuncs.com/img/%E5%AD%90%E7%BD%91%E6%8E%A9%E7%A0%81%E8%BF%90%E7%AE%97%E4%BE%8B%E5%AD%90.png)
