# 进程的描述与控制

# 进程的描述与控制

## 进程的描述

### 定义

- 程序

  - 就是一个指令序列
- 程序段，数据段，PCB三部分组成了进程实体 （进程映像）

  - PCB是进程存在的唯一标志
- 进程是进程实体的运行过程，是系统进行资源分配和调度的一个独立单位

  - 严格来说，进程实体和进程并不一样，进程实体是静态的，进程则是动态的

### 组成

- PCB

  - 进程描述信息

    - 进程标识符PID

      - 当进程被创建时，操作系统会为该进程分配一个唯一的，不重复的ID，用于区分不同的进程
    - 用户标识符UID
  - 进程控制和管理信息

    - 进程当前状态
    - 进程优先级
  - 资源分配清单

    - 程序段指针
    - 数据段指针
    - 键盘
    - 鼠标
  - 处理机相关信息

    - 各种寄存器值

      - 当进程切换时需要把进程当前的运行情况记录下来保存在PCB中，如程序计数器的值表示了当前程序执行到那一句
    - 进程标识符
    - 处理机状态
    - 进程调度信息
    - 进程控制信息
- 程序段

  - 存放要执行的代码
- 数据段

  - 存放程序运行过程中处理的各种数据

### 组织方式

- 链接方式

  - 按照进程状态将PCB分为多个队列
  - 操作系统持有指向各个队列的指针
- 索引方式

  - 根据进程状态的不同，建立几张索引表
  - 操作系统持有指向各个索引表的指针

### 特征

- 动态性

  - 进程是程序的一次执行过程，是动态地产生，变化和消亡
- 并发性

  - 内存中有多个进程实体，各进程可并发执行
- 独立性

  - 进程是能独立运行，独立获得资源，独立接受调度的基本单位
- 异步性

  - 各进程按各自独立的，不可预知的速度向前推进，操作系统要提供“进程同步机制"来解决异步问题
- 结构性

  - 每个进程都会配置一个PCB。结构上看，进程由程序段，数据段，PCB组成

### 状态

- 运行状态

  - 占用CPU，并在CPU上运行
- 就绪状态

  - 已经具备运行条件，但由于没有空闲CPU，而暂时不能运行
- 阻塞状态

  - 因等待某一事件而暂时不能运行
- 创建状态

  - 进程正在被创建，操作系统为进程分配资源，初始化PCB
- 终止状态

  - 进程正在从系统中撤销，操作系统会回收进程拥有的资源，撤销PCB

### 进程状态间的切换

## 进程控制

### 基本概念

- 进程控制的主要功能是对系统中的所有进程实施有效的管理，它具有创建新进程，撤销已有进程，实现进程状态转换等功能
- 进程控制就是要实现进程状态的切换
- 进程控制用原语实现

  - 原语用关/开中断来实现
  - 原语是一种特殊的程序
  - 原语的执行必须一气呵成，不可中断

### 进程控制相关的原语

- 进程的创建

  - 创建原语

    - 申请空白PCB
    - 为新进程分配所需资源
    - 初始化PCB
    - 将PCB插入就绪队列
  - 引起进程创建的事件

    - 用户登录

      - 分时系统中，用户登录成功，系统就会为其建立一个新的进程
    - 作业调度

      - 多道批处理系统中，有新的作业放入内存时，会为其建立一个新的进程
    - 提供服务

      - 用户向操作系统提出某些请求时，会新建一个进程处理该请求
    - 应用请求

      - 由用户进程主动请求创建一个子进程
- 进程的终止

  - 撤销原语

    - 从PCB集合中找到终止进程的PCB
    - 若进程正在运行，立即剥多CPU，将CPU分配给其它进程
    - 终止其所有子进程
    - 将该进程拥有的所有资源归还给父进程或操作系统
    - 删除CPU
  - 引起进程终止的事件

    - 正常结束
    - 异常结束
    - 外界干预
- 进程的阻塞

  - 阻塞原语

    - 找到要阻塞的进程对应的PCB
    - 保护进程运行现场，将PCB状态信息设置为“阻塞态”,暂时停止进程运行
    - 将PCB插入相应事件的等待队列
  - 引起进程阻塞的事件

    - 需要等待系统分配某种资源
    - 需要等待相互合作的其他进程完成工作
- 进程的唤醒

  - 唤醒原语

    - 在事件等待队列中找到PCB
    - 将PCB从等待队列移除，设置进程为就绪态
    - 将PCB插入就绪队列，等待被调度
  - 引起进程唤醒的事件

    - 等待的事件发生
    - 应何事阻塞，就应由何事唤醒
- 进程的切换

  - 切换原语

    - 将运行环境信息存入PCB
    - PCB移入相应队列
    - 选择另一个进程执行，并更新其PCB
    - 根据PCB恢复新进程所需的运行环境
  - 引起进程切换的事件

    - 当前进程时间片到
    - 有更高优先级的进程到达
    - 当前进程主动阻塞
    - 当前进程终止

## 进程通信

### 概念

- 进程之间的消息交换
- 进程是分配系统资源的单位（包括内存地址空间）,因此各进程拥有的内存地址空间相互独立，为了保证安全，一个进程不能直接访问另一个进程的地址空间

### 共享存储

- 两个进程对共享空间的访问必须是互斥的
- 设置一个共享空间
- 要互斥地访问共享空间
- 两种方式

  - 基于数据结构的共享
  - 基于存储区的共享

### 消息传递

- 进程间的数据交换以格式化的消息（Message)为单位。进程通过操作系统提供的“发送消息/接收消息”两个原语进行数据交换。
- 传递结构化的消息（消息头/消息体）
- 系统提供“发送/接受原语”
- 两种方式

  - 直接通信方式

    - 消息直接挂到接受进程的消息缓冲队列上
  - 间接通信方式

    - 消息要先发送到中间实体（信箱）中

### 管道通信

- 数据以字符流的形式写入管道，当管道写满时，写进程的write()系统调用将被阻塞，等待读进程将数据取走。当读进程将数据全部取走后，管道变空，此时读进程的read()系统调用将被阻塞。
- 数据一旦被读出，就从管道中被抛弃，这就意味着读进程最多只能有一个，否则可能会有读错数据的情况。
- 设置一个特殊的共享文件（管道），其实就是一个缓冲区
- 一个管道只能实现半双工通信
- 实现双向同时通信要建立两个管道
- 各进程要互斥访问管道
- 写满时，不能再写。读写时，不能在读
- 没写满时，不能读没读空，不能写

## 线程

### 线程是一个基本的CPU执行单位，也是线程执行流的最小单位

### 引入线程带来的变化

- 资源分配，调度

  - 传统进程机制中，进程是资源分配，调度的基本单位
  - 引入线程后，进程是资源分配的基本单位，线程是调度的基本单位
- 并发性

  - 传统进程机制中，只能进程间并发
  - 引入线程后，各线程间也能并发，提升了并发度
- 系统开销

  - 传统的进程间并发，需要切换进程的运行环境，系统开销大
  - 线程间并发，如果是同一进程内的线程切换，则不需要切换进程环境，系统开销小
  - 引入线程后，并发所带来的系统开销小

### 属性

- 线程是处理机调度的单位
- 多CPU计算机中，各个线程可占用不同的CPU
- 每个线程都有一个线程ID，线程控制块（TCB）
- 线程也有就绪，阻塞，运行三种基本状态
- 线程几乎不拥有系统资源
- 同一进程的不同线程间共享进程的资源
- 由于共享内存地址空间，同一进程中的线程间通信甚至无需系统干预
- 同一进程中的线程切换，不会引起进程切换
- 不同进程中的线程切换，会引起进程切换
- 切换同进程内的线程，系统开销很小
- 切换进程，系统开销较大

### 线程的实现方式

- 用户级线程

  - 从用户视角看的线程
- 内核级线程

  - 从操作系统视角看的进程（内核级线程才是处理机分配的单位）
- 组合方式

  - 上述两种方式的结合

### 多线程模型

- 多对一模型

  - 优

    - 进程管理开销小效率高
  - 缺

    - 一个线程阻塞会导致整个进程都被阻塞（并发度低）
- 一对一模型

  - 优

    - 进程管理开销大
  - 缺

    - 各个线程可分配到多核处理机并行执行，并发度高
- 多对多模型

  - 集二者之所长
