# O设备

# I/O设备

## I/O设备的基本概念与分类

### 什么是I/O设备

- 将数据Input/Output(输入/输出）计算机的外部设备

### 按使用特性分类

- 人机交互类外部设备
- 存储设备
- 网络通信设备

### 按传输速率分类

- 低速设备
- 中速设备
- 高速设备

### 按信息交换的单位分类

- 块设备（传输快，可寻址)
- 字符设备（传输慢，不可寻址，常采用中断驱动方式）

## I/O控制器

### 主要功能

- 接受和识别CPU发出的命令（要有控制寄存器）
- 向CPU报告设备的状态（要有状态寄存器）
- 数据交换(要有数据寄存器，暂存输入/输出的数据)
- 地址识别（由I/O逻辑实现）

### 组成

- CPU与控制器之间的接口（实现控制器与CPU之间的通信）
- l/O逻辑（负责识别CPU发出的命令，并向设备发出命令)
- 控制器与设备之间的接口（实现控制器与设备之间的通信）

### 两种寄存器编址方式

- 内存映射I/O

  - 控制器中的寄存器与内存统一编制
  - 可以采用对内存进行操作的指令来对控制器进行操作
- 寄存器独立编制

  - 控制器中的寄存器独立编制
  - 需要设置专门的指令来操作控制器

## I/O控制方式

### 程序直接控制方式

- 完成异常读/写的过程

  - CPU发出I/O命令后需要不断轮询
- CPU干预频率

  - 极高
- 每次I/O的数据传输单位

  - 字
- 数据流向

  - 设备→CPU→内存
    内存→CPU→设备

### 中断驱动方式

- 完成异常读/写的过程

  - CPU发出I/O命令后可以做其他事，本次I/0完成后设备控制器发出中断信号
- CPU干预频率

  - 高
- 每次I/O的数据传输单位

  - 字
- 数据流向

  - 设备→CPU→内存
    内存→CPU→设备

### DMA方式

- 完成异常读/写的过程

  - CPU发出I/O命令后可以做其他事，本次l/0完成后DMA控制器发出中断信号
- CPU干预频率

  - 中
- 每次I/O的数据传输单位

  - 块
- 数据流向

  - 设备→内存
    内存→设备

### 通道控制方式

- 完成异常读/写的过程

  - CPU发出I/O命令后可以做其他事。通道会执行通道程序以完成I/O，完成后通道向CPU发出中断信号
- CPU干预频率

  - 中
- 每次I/O的数据传输单位

  - 一组块
- 数据流向

  - 设备→内存
    内存→设备

### 优缺点

- 每一个阶段的优点都是解决了上一阶段的最大缺点。总体来说，整个发展过程就是要尽量减少CPU对I/O过程的干预，把CPU从繁杂的l/0控制事务中解脱出来，以便更多地去完成数据处理任务。

## 假脱机技术/SPOOLing技术

### 脱机技术

- 外围控制机+更高速的设备——磁带
- 作用：缓解设备与CPU的速度矛盾，实现预输入、缓输出

### 假脱机技术

- 又叫SPOOLing技术，用软件的方式模拟脱机技术
- 输入井和输出井——模拟脱机输入/输出时的磁带
- 输入进程和输出进程——模拟脱机输入/输出时的外围控制机
- 输入缓冲区和输出缓冲区——内存中的缓冲区，输入、输出时的“中转站”

### 共享打印机

- 用SPOOLing技术将独占式的打印机"虚拟"成共享打印机

## 设备的分配与回收

### 应考虑的因素

- 固有属性

  - 独占设备、共享设备、虚拟设备（SPOOLing）
- 分配算法

  - 先来先服务、优先级高者优先、短任务优先等
- 安全性

  - 安全分配方式、不安全分配方式

### 静态分配与动态分配

- 静态分配：进程运行前为其分配全部所需资源，运行结束后归还资源
- 动态分配：进程运行过程中动态申请设备资源

### 设备分配管理中的数据结构

- 设备控制表（DCT）

  - 每个设备对应一张DCT，关键字段：类型/标识符/状态/指向COCT的指针/等待队列指针
- 控制器控制表（COCT)

  - 每个控制器对应一张COCT，关键字段：状态/指向CHCT的指针/等待队列指针
- 通道控制表（CHCT)

  - 每个控制器对应一张CHCT，关键字段：状态/等待队列指针
- 系统设备表（SDT)

  - 记录整个系统中所有设备的情况，每个设备对应一个表目，关键字段：设备类型/标识符/DCT/驱动程序入口

### 设备分配的步骤

- ①根据进程请求的物理设备名查找SDT；
  ②根据SDT找到DCT并分配设备；
  ③根据DCT找到COCT并分配控制器；
  ④根据COCT找到CHCT并分配通道
- 注：只有设备、控制器、通道三者都分配成功时，这次设备分配才算成功，之后便可启动I/O设备进行数据传送
- 缺点：

  - 用户编程时必须使用“物理设备名”，若换了一个物理设备，则程序无法运行。若进程请求的物理设备正在忙碌，则即使系统中还有同类型的设备，进程也必须阻塞等待

### 设备分配步骤的改进

- 用户编程时使用逻辑设备名申请设备，操作系统负责实现从逻辑设备名到物理设备名的映射（通过LUT）
- 逻辑设备表的设置问题

  - 整个系统只有一张LUT：各用户所用的逻辑设备名不允许重复
  - 每个用户一张LUT：各个用户的逻辑设备名可重复

## 缓冲区管理

### 缓冲区的概念

- 一般利用内存作为缓冲区
- 缓解CPU与设备的速度矛盾、
  减少对CPU的中断频率、
  解决数据粒度不匹配的问题、
  提高CPU与I/O设备之间的并行性

### 单缓冲

- 设备—（T）一缓冲区—（M)一工作区—（C)一处理
- 处理一块数据平均耗时Max（C,T)+M
- 分析问题的初始状态：工作区满，缓冲区空

### 双缓冲

- 处理一块数据平均耗时Max(T，C+M)
- 分析问题的初始状态：工作区空，一个缓冲区满，另一个缓冲区空

### 循环缓冲

- 多个缓冲区链接成循环队列，in指针指向第一个空缓冲区，out指针指向第一个满缓冲区

### 缓冲池

- 三个队列：空缓冲队列、输入队列、输出队列
- 四种工作缓冲区

  - 用于收容输入数据的工作缓冲区、用于提取输入数据的工作缓冲区
  - 用于收容输出数据的工作缓冲区、用于提取输出数据的工作缓冲区
