# 虚拟内存

# 虚拟内存

## 虚拟内存的基本概念

### 传统存储管理方式的特征，缺点

- 一次性：作业数据必须一次全部调入内存
- 驻留性：作业数据在整个运行期间都会常驻内存

### 局部性原理

- 时间局部性：现在访问的指令、数据在不久后很可能会被再次访问
- 空间局部性：现在访问的内存单元周围的内存空间，很可能在不久后会被访问
- 高速缓存技术：使用频繁的数据放到更高速的存储器中

### 虚拟内存的定义和特征

- 程序不需全部装入即可运行，运行时根据需要动态调入数据，若内存不够，还需换出一些数据
- 特征

  - 多次性：无需在作业运行时一次性全部装入内存，而是允许被分成多次调入内存。
  - 对换性：无需在作业运行时一直常驻内存，而是允许在作业运行过程中，将作业换入、换出。
  - 虚拟性：从逻辑上扩充了内存的容量，使用户看到的内存容量，远大于实际的容量。

### 如何实现虚拟内存技术

- 访问的信息不在内存时，由操作系统负责将所需信息从外存调入内存（请求调页功能）
- 内存空间不够时，将内存中暂时用不到的信息换出到外存（页面置换功能)
- 虚拟内存的实现

  - 请求分页存储管理
  - 请求分段存储管理
  - 请求段页式存储管理

## 请求分页管理方式

### 页表机制

- 在基本分页的基础上增加了几个表项
- 状态位：表示页面是否已在内存中
- 访问字段：记录最近被访问过几次，或记录上次访问的时间，供置换算法选择换出页面时参考
- 修改位：表示页面调入内存后是否被修改过，只有修改过的页面才需在置换时写回外存
- 外存地址：页面在外存中存放的位置

### 缺页中断机制

- 找到页表项后检查页面是否已在内存，若没在内存，产生缺页中断
- 缺页中断处理中，需要将目标页面调入内存，有必要时还要换出页面
- 缺页中断属于内中断，属于内中断中的“故障”，即可能被系统修复的异常
- 一条指令在执行过程中可能产生多次缺页中断

### 地址变换机构（重点关注与基本分页不同的地方）

- 找到页表项是需要检查页面是否在内存中
- 若页面不再内存中，需要请求调页
- 若内存空间不够，还需换出页面
- 页面调入内存后，需要修改相应页表项

## 页面置换算法

### 最佳置换算法(OPT)

- 算法规则

  - 优先淘汰最长时间内不会被访问的页面
- 优缺点

  - 缺页率最小，性能最好；但无法实现

### 先进先出置换算法(FIFO)

- 算法规则

  - 优先淘汰最先进入内存的页面
- 优缺点

  - 实现简单；但性能很差，可能出现Belady异常

### 最近最久未使用置换算法(LRU)

- 算法规则

  - 优先淘汰最近最久没访问的页面
- 优缺点

  - 性能很好；但需要硬件支持，算法开销大

### 时钟置换算法（CLOCK)

- 算法规则

  - 循环扫描各页面
  - 第一轮淘汰访问位=0的，并将扫描过的页面访问位改为1。若第一轮没选中，则进行第二轮扫描。
- 优缺点

  - 实现简单，算法开销小；但未考虑页面是否被修改过。

### 改进型的时钟置换算法

- 算法规则

  - 若用(访问位，修改位）的形式表述，则
    第一轮：淘汰(0,0)
    第二轮：淘汰（0，1），并将扫描过的页面访问都置为0
    第三轮：淘汰（0,0）
    第四轮：淘汰（0,1）
- 优缺点

  - 算法开销较小，性能也不错

## 页面分配策略

### 驻留集

- 指请求分页存储管理中 给进程分配的内存块的集合

### 页面分配，置换策略

- 固定分配局部置换

  - 系统为每个进程分配一定数量的物理块，在整个运行期间都不改变。若进程在运行中发生缺页，则只能从该进程在内存中的页面中选出一页换出，然后再调入需要的页面。
  - 缺点

    - 很难在刚开始就确定应为每个进程分配多少个物理块才算合理。(采用这种策略的系统可以根据进程大小、优先级、或是根据程序员给出的参数来确定为一个进程分配的内存块数）
- 可变分配全局置换

  - 刚开始会为每个进程分配一定数量的物理块。操作系统会保持一个空闲物理块队列。当某进程发生缺页时，从空闲物理块中取出一块分配给该进程；若已无空闲物理块，则可选择一个未锁定的页面换出外存，再将该物理块分配给缺页的进程。采用这种策略时，只要某进程发生缺页，都将获得新的物理块，仅当空闲物理块用完时，系统才选择一个未锁定的页面调出。被选择调出的页可能是系统中任何一个进程中的页，因此这个被选中的进程拥有的物理块会减少，缺页率会增加。
- 可变分配局部置换

  - 刚开始会为每个进程分配一定数量的物理块。当某进程发生缺页时，只允许从该进程自己的物理块中选出一个进行换出外存。如果进程在运行中频繁地缺页，系统会为该进程多分配几个物理块，直至该进程缺页率趋势适当程度；反之，如果进程在运行中缺页率特别低，则可适当减少分配给该进程的物理块。
- 可变分配全局置换

  - 只要缺页就给分配新物理块
- 可变分配局部置换

  - 要根据发生缺页的频率来动态地增加或减少进程的物理块
- 区别

  - 固定分配VS可变分配：区别在于进程运行期间驻留集大小是否可变
  - 局部置换VS全局置换：区别在于发生缺页时是否只能从进程自己的页面中选择一个换出
  - 固定分配局部置换：进程运行前就分配一定数量物理块，缺页时只能换出进程自己的某一页
  - 可变分配全局置换：只要缺页就分配新物理块，可能来自空闲物理块，也可能需换出别的进程页面
  - 可变分配局部置换：频繁缺页的进程，多分配一些物理块；缺页率很低的进程，回收一些物理块。直到缺页率合适

### 何时调入页面

- 预调页策略：一般用于进程运行前
- 请求调页策略：进程运行时，发现缺页再调页

### 从何处调页

- 对换区——采用连续存储方式，速度更快；文件区——采用离散存储方式，速度更慢。
- 对换区足够大：运行将数据从文件区复制到对换区，之后所有的页面调入、调出都是在内存与对换区之间进行
- 对换区不够大：不会修改的数据每次都从文件区调入；会修改的数据调出到对换区，需要时再从对换区调入
- UNIX方式：第一次使用的页面都从文件区调入；调出的页面都写回对换区，再次使用时从对换区调入

### 抖动（颠簸）现象

- 页面频繁换入换出的现象。主要原因是分配给进程的物理块不够

### 工作集

- 在某段时间间隔里，进程实际访问页面的集合。驻留集大小一般不能小于工作集大小

## 内存映射文件

### 特性

- 进程可使用系统调用，请求操作系统将文件映射到进程的虚拟地址空间
- -以访问内存的方式读写文件
- 进程关闭文件时，操作系统负责将文件数据写回磁盘，并解除内存映射
- -多个进程可以映射同一个文件，方便共享

### 优点

- 程序员编程更简单，已建立映射的文件，只需按访问内存的方式读写即可
- 文件数据的读入/写出完全由操作系统负责，I/O效率可以由操作系统负责优化
